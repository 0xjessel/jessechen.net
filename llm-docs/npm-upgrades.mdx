# NPM Package Upgrade Guide

This document outlines the process, findings, and challenges related to updating npm packages in the jessechen.net project.

## Upgrade Strategy

The upgrade process has been organized into three groups, ordered from least to most risky:

### Group 3: Utility Tools

- ✅ remark-slug v7 → rehype-slug (latest)
- ❌ eslint v8 → v9 (conflicted with eslint-config-next v14)

### Group 2: UI Libraries

- @chakra-ui/react v2 → v3
- framer-motion v11 → v12

### Group 1: Next.js Ecosystem

- ✅ next v14 → v15
- ✅ eslint-config-next v14 → v15
- ✅ react v18 → v19 (optional, Next.js 15 supports both v18 and v19)

## Migration Details

### Group 1: Next.js Ecosystem Migration

The Next.js ecosystem migration was completed successfully. Key steps included:

1. **Package Updates**:

   - Upgraded Next.js from v14.2.5 to the latest v15.x
   - Upgraded eslint-config-next from v14.2.5 to the latest v15.x
   - Upgraded React and React DOM from v18.3.1 to the latest v19.x

2. **Code Changes**:
   - Updated the Link API implementation across the codebase to remove deprecated `passHref` and `legacyBehavior` props
   - Updated imports from `NextLink` to `Link` throughout the codebase
   - No changes were required for MDX processing as next-mdx-remote was already at a compatible version

Detailed documentation of the migration process is available in [llm-docs/next15-migration.mdx](llm-docs/next15-migration.mdx).

## Findings and Insights

### Dependency Interdependencies

One of the key challenges with updating packages is managing interdependencies. Notable examples:

1. **ESLint and eslint-config-next**: Attempting to update ESLint to v9 while keeping eslint-config-next at v14 led to dependency conflicts. This indicates that major version updates often need to be coordinated across related packages.

2. **Next.js Peer Dependencies**: Next.js v15 has the following peer dependencies:

   ```json
   {
     "sass": "^1.3.0",
     "react": "^18.2.0 || 19.0.0-rc-de68d2f4-20241204 || ^19.0.0",
     "react-dom": "^18.2.0 || 19.0.0-rc-de68d2f4-20241204 || ^19.0.0",
     "@playwright/test": "^1.41.2",
     "@opentelemetry/api": "^1.1.0",
     "babel-plugin-react-compiler": "*"
   }
   ```

   This shows that Next.js v15 is compatible with both React v18 and v19, giving flexibility for the upgrade path.

3. **Chakra UI Peer Dependencies**: Chakra UI v3 requires:
   ```json
   {
     "react": ">=18",
     "react-dom": ">=18",
     "@emotion/react": ">=11"
   }
   ```
   This confirms compatibility with both React v18 and v19.

### Package Deprecations

Some packages have been deprecated in favor of newer alternatives:

1. **remark-slug → rehype-slug**: The package remark-slug v8 was deprecated with a recommendation to use rehype-slug instead. This required code changes to:
   - Import the new package
   - Move the plugin from remarkPlugins to rehypePlugins in the MDX serialization

## Challenges and Solutions

### Incompatible Major Versions

Major version updates often include breaking changes. For example:

1. **ESLint v9**: Breaking changes required coordinated updates with eslint-config-next.

   - Solution: Wait to update ESLint along with eslint-config-next.

2. **Deprecated Packages**: When remark-slug was updated, we discovered it was deprecated.
   - Solution: Replace with the recommended alternative (rehype-slug) and update the code accordingly.

### Next.js 15 Migration Challenges

1. **Link API Changes**: Next.js 15 removes support for the legacy Link API.

   - Solution: Update all Link components to use the modern API by removing `passHref` and `legacyBehavior` props.

2. **Hydration Errors**: After migrating to Next.js 15, we encountered hydration errors due to nested anchor tags. In Next.js 15, the Link component now renders as an `<a>` tag by default, causing invalid HTML when nested with ChakraLink components.

   - Solution: Replace nested Link and ChakraLink combinations with a single Link component using inline styles for the styling previously provided by ChakraLink.

3. **Peer Dependencies**: When upgrading to Next.js 15, peer dependency warnings appeared.
   - Solution: These warnings were acceptable since Next.js 15 supports both React 18 and React 19.

## Best Practices for NPM Updates

From our experience updating this codebase, we've identified these best practices:

1. **Check Peer Dependencies**: Before updating a package, check its peer dependencies to understand what other packages might be affected.

2. **Update in Groups**: Group related packages together and update them as a unit.

3. **Start with Low-Risk Updates**: Begin with utility packages that have fewer dependencies and are less likely to affect core functionality.

4. **Test After Each Update**: Verify functionality after each group of updates before proceeding to the next.

5. **Check for Deprecations**: Look for deprecation warnings and follow recommended migration paths.

6. **Consult Migration Guides**: Review official migration guides for major version updates to understand potential breaking changes.

## Next Steps

The remaining updates are grouped by risk level:

1. **Group 2** (UI Libraries): Update Chakra UI and Framer Motion.

With Group 1 (Next.js Ecosystem) successfully updated, we can now proceed to updating the UI libraries in Group 2 if desired.
